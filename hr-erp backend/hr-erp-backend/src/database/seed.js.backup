const bcrypt = require('bcryptjs');
const { query } = require('./connection');
const { logger } = require('../utils/logger');

/**
 * AdatbÃ¡zis feltÃ¶ltÃ©se tesztadatokkal
 */
async function seedDatabase() {
  try {
    logger.info('ðŸŒ± AdatbÃ¡zis seed indÃ­tÃ¡sa...');

    // 1. Tenant lÃ©trehozÃ¡sa
    logger.info('Tenant-ok lÃ©trehozÃ¡sa...');
    const tenantResult = await query(`
      INSERT INTO tenants (name, slug, email, phone, is_active)
      VALUES 
        ('ABC Kereskedelmi Kft.', 'abc-kft', 'info@abc-kft.hu', '+36 1 234 5678', true),
        ('XYZ SzolgÃ¡ltatÃ³ Zrt.', 'xyz-zrt', 'info@xyz-zrt.hu', '+36 1 987 6543', true)
      RETURNING id, name
    `);

    const tenant1Id = tenantResult.rows[0].id;
    const tenant2Id = tenantResult.rows[1].id;
    logger.info(`âœ“ ${tenantResult.rows.length} tenant lÃ©trehozva`);

    // 2. SzerepkÃ¶rÃ¶k lekÃ©rÃ©se
    const rolesResult = await query('SELECT id, slug FROM roles');
    const roles = {};
    rolesResult.rows.forEach(role => {
      roles[role.slug] = role.id;
    });

    // 3. FelhasznÃ¡lÃ³k lÃ©trehozÃ¡sa
    logger.info('FelhasznÃ¡lÃ³k lÃ©trehozÃ¡sa...');
    const passwordHash = await bcrypt.hash('password123', 10);

    const usersResult = await query(`
      INSERT INTO users (tenant_id, email, password_hash, first_name, last_name, is_active)
      VALUES 
        -- Szuperadmin (tenant fÃ¼ggetlen)
        (NULL, 'admin@hr-erp.com', $1, 'Admin', 'User', true),
        
        -- ABC Kft. felhasznÃ¡lÃ³k
        ($2, 'kiss.janos@abc-kft.hu', $1, 'Kiss', 'JÃ¡nos', true),
        ($2, 'nagy.eva@abc-kft.hu', $1, 'Nagy', 'Ã‰va', true),
        ($2, 'toth.anna@abc-kft.hu', $1, 'TÃ³th', 'Anna', true),
        
        -- XYZ Zrt. felhasznÃ¡lÃ³k
        ($3, 'kovacs.peter@xyz-zrt.hu', $1, 'KovÃ¡cs', 'PÃ©ter', true),
        ($3, 'szabo.maria@xyz-zrt.hu', $1, 'SzabÃ³', 'MÃ¡ria', true),
        
        -- KÃ¼lsÅ‘ alvÃ¡llalkozÃ³k
        ($2, 'vizvezetek@example.com', $1, 'VÃ­zvezetÃ©k', 'Kft.', true),
        ($2, 'it-support@example.com', $1, 'IT', 'Support', true)
      RETURNING id, email, tenant_id
    `, [passwordHash, tenant1Id, tenant2Id]);

    logger.info(`âœ“ ${usersResult.rows.length} felhasznÃ¡lÃ³ lÃ©trehozva`);

    // User ID-k
    const adminId = usersResult.rows[0].id;
    const kissJanosId = usersResult.rows[1].id;
    const nagyEvaId = usersResult.rows[2].id;
    const tothAnnaId = usersResult.rows[3].id;
    const kovacsPeterId = usersResult.rows[4].id;
    const szaboMariaId = usersResult.rows[5].id;
    const vizvezetekId = usersResult.rows[6].id;
    const itSupportId = usersResult.rows[7].id;

    // 4. SzerepkÃ¶rÃ¶k hozzÃ¡rendelÃ©se
    logger.info('SzerepkÃ¶rÃ¶k hozzÃ¡rendelÃ©se...');
    await query(`
      INSERT INTO user_roles (user_id, role_id, tenant_id)
      VALUES 
        -- Szuperadmin
        ($1, $2, NULL),
        
        -- ABC Kft.
        ($3, $4, $5),  -- Kiss JÃ¡nos - Admin
        ($6, $7, $5),  -- Nagy Ã‰va - Feladat-felelÅ‘s
        ($8, $9, $5),  -- TÃ³th Anna - FelhasznÃ¡lÃ³
        ($10, $11, $5), -- VÃ­zvezetÃ©k Kft. - AlvÃ¡llalkozÃ³
        ($12, $11, $5), -- IT Support - AlvÃ¡llalkozÃ³
        
        -- XYZ Zrt.
        ($13, $4, $14), -- KovÃ¡cs PÃ©ter - Admin
        ($15, $9, $14)  -- SzabÃ³ MÃ¡ria - FelhasznÃ¡lÃ³
    `, [
      adminId, roles.superadmin,
      kissJanosId, roles.admin, tenant1Id,
      nagyEvaId, roles.task_owner, tenant1Id,
      tothAnnaId, roles.user, tenant1Id,
      vizvezetekId, roles.contractor, tenant1Id,
      itSupportId, roles.contractor, tenant1Id,
      kovacsPeterId, roles.admin, tenant2Id,
      szaboMariaId, roles.user, tenant2Id
    ]);

    logger.info('âœ“ SzerepkÃ¶rÃ¶k hozzÃ¡rendelve');

    // 5. Ticket kategÃ³riÃ¡k lÃ©trehozÃ¡sa
    logger.info('Ticket kategÃ³riÃ¡k lÃ©trehozÃ¡sa...');
    const categoriesResult = await query(`
      INSERT INTO ticket_categories (tenant_id, name, slug, color, icon)
      VALUES 
        ($1, 'HR', 'hr', '#3730a3', 'ðŸ‘¥'),
        ($1, 'Technikai', 'technical', '#5b21b6', 'ðŸ”§'),
        ($1, 'PÃ©nzÃ¼gyi', 'finance', '#831843', 'ðŸ’°'),
        ($1, 'ÃltalÃ¡nos', 'general', '#64748b', 'ðŸ“‹')
      RETURNING id, slug
    `, [tenant1Id]);

    const categories = {};
    categoriesResult.rows.forEach(cat => {
      categories[cat.slug] = cat.id;
    });

    logger.info('âœ“ KategÃ³riÃ¡k lÃ©trehozva');

    // 6. PrioritÃ¡sok Ã©s stÃ¡tuszok lekÃ©rÃ©se
    const prioritiesResult = await query('SELECT id, slug FROM priorities');
    const priorities = {};
    prioritiesResult.rows.forEach(p => {
      priorities[p.slug] = p.id;
    });

    const statusesResult = await query('SELECT id, slug FROM ticket_statuses');
    const statuses = {};
    statusesResult.rows.forEach(s => {
      statuses[s.slug] = s.id;
    });

    // 7. Ticketek lÃ©trehozÃ¡sa
    logger.info('Ticketek lÃ©trehozÃ¡sa...');
    await query(`
      INSERT INTO tickets (
        tenant_id, ticket_number, title, description, 
        category_id, status_id, priority_id, created_by, assigned_to
      )
      VALUES 
        -- Folyamatban lÃ©vÅ‘ ticket
        ($1, '#1243', 'VÃ­zvezetÃ©k javÃ­tÃ¡s - A Ã©pÃ¼let', 
         'Az A Ã©pÃ¼let 2. emeletÃ©n a mosdÃ³ban szivÃ¡rgÃ¡s Ã©szlelhetÅ‘. A csap alatt folyamatosan csÃ¶pÃ¶g a vÃ­z.', 
         $2, $3, $4, $5, $6),
        
        -- Ãšj ticket
        ($1, '#1242', 'HR dokumentum igÃ©nylÃ©s', 
         'KÃ©rnÃ©m az elmÃºlt 3 hÃ³nap bÃ©rszÃ¡mfejtÃ©sÃ©nek Ã¶sszesÃ­tÃ©sÃ©t.', 
         $7, $8, $9, $10, NULL),
        
        -- LezÃ¡rt ticket
        ($1, '#1241', 'SzÃ¡mÃ­tÃ³gÃ©p javÃ­tÃ¡s', 
         'A szÃ¡mÃ­tÃ³gÃ©p nem indul el, fekete kÃ©pernyÅ‘ jelenik meg.', 
         $2, $11, $9, $5, $12),
        
        -- Anyagra vÃ¡rÃ³ ticket
        ($1, '#1240', 'BÃºtor csere - B iroda', 
         'Az irodai szÃ©kek cserÃ©je szÃ¼ksÃ©ges, ergonÃ³miai problÃ©mÃ¡k miatt.', 
         $2, $13, $9, $10, $6)
    `, [
      tenant1Id, 
      categories.technical, statuses.in_progress, priorities.urgent, tothAnnaId, vizvezetekId,
      categories.hr, statuses.new, priorities.normal, tothAnnaId,
      categories.technical, statuses.completed, priorities.normal, tothAnnaId, itSupportId,
      categories.technical, statuses.waiting_material, priorities.normal, tothAnnaId, vizvezetekId
    ]);

    logger.info('âœ“ Ticketek lÃ©trehozva');

    // 8. MegjegyzÃ©sek hozzÃ¡adÃ¡sa
    logger.info('MegjegyzÃ©sek hozzÃ¡adÃ¡sa...');
    const ticketsResult = await query(
      'SELECT id, ticket_number FROM tickets WHERE tenant_id = $1 ORDER BY created_at',
      [tenant1Id]
    );

    // ElsÅ‘ tickethez (#1243 - VÃ­zvezetÃ©k)
    await query(`
      INSERT INTO ticket_comments (ticket_id, user_id, comment)
      VALUES 
        ($1, $2, 'Jegy Ã¡tadva a VÃ­zvezetÃ©k Kft.-nek. KÃ©rem, foglalkozzanak vele sÃ¼rgÅ‘sen!'),
        ($1, $3, 'Holnap reggel 9-kor kimegyÃ¼nk a helyszÃ­nt felmÃ©rni. ðŸ“¸'),
        ($1, $3, 'HelyszÃ­ni szemle kÃ©sz. CsÃ¶vet kell cserÃ©lni, alkatrÃ©szt rendeltem. VÃ¡rhatÃ³ megoldÃ¡s: 2-3 nap.')
    `, [ticketsResult.rows[0].id, kissJanosId, vizvezetekId]);

    logger.info('âœ“ MegjegyzÃ©sek hozzÃ¡adva');

    // 9. Ticket history bejegyzÃ©sek
    logger.info('Ticket tÃ¶rtÃ©net bejegyzÃ©sek...');
    for (const ticket of ticketsResult.rows) {
      await query(`
        INSERT INTO ticket_history (ticket_id, user_id, action, new_value)
        VALUES ($1, $2, 'created', $3)
      `, [ticket.id, tothAnnaId, ticket.ticket_number]);
    }

    logger.info('âœ“ TÃ¶rtÃ©net bejegyzÃ©sek lÃ©trehozva');

    logger.info('âœ… Seed befejezve!');
    logger.info('');
    logger.info('ðŸ“ Teszt bejelentkezÃ©si adatok:');
    logger.info('-----------------------------------');
    logger.info('Szuperadmin:');
    logger.info('  Email: admin@hr-erp.com');
    logger.info('  JelszÃ³: password123');
    logger.info('');
    logger.info('ABC Kft. Admin:');
    logger.info('  Email: kiss.janos@abc-kft.hu');
    logger.info('  JelszÃ³: password123');
    logger.info('');
    logger.info('FelhasznÃ¡lÃ³:');
    logger.info('  Email: toth.anna@abc-kft.hu');
    logger.info('  JelszÃ³: password123');
    logger.info('');
    logger.info('AlvÃ¡llalkozÃ³:');
    logger.info('  Email: vizvezetek@example.com');
    logger.info('  JelszÃ³: password123');
    logger.info('-----------------------------------');

  } catch (error) {
    logger.error('âŒ Seed hiba:', error);
    throw error;
  }
}

// FuttatÃ¡s, ha kÃ¶zvetlenÃ¼l hÃ­vjuk
if (require.main === module) {
  seedDatabase()
    .then(() => {
      logger.info('Seed sikeresen befejezve');
      process.exit(0);
    })
    .catch(error => {
      logger.error('Seed sikertelen:', error);
      process.exit(1);
    });
}

module.exports = { seedDatabase };
